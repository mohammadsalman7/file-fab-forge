# Set correct MIME types
<IfModule mod_mime.c>
	AddType text/javascript .js
	AddType text/javascript .mjs
	AddType application/wasm .wasm
	AddType application/json .json
	AddType application/xml .xml
	AddType text/xml .xml
	AddType image/svg+xml .svg
	AddType text/css .css
</IfModule>

# Security headers
<IfModule mod_headers.c>
	Header set X-Content-Type-Options "nosniff"
</IfModule>

# Force XML MIME type for sitemap.xml
<Files "sitemap.xml">
	ForceType application/xml
</Files>

# Enable compression
<IfModule mod_deflate.c>
	AddOutputFilterByType DEFLATE text/plain
	AddOutputFilterByType DEFLATE text/html
	AddOutputFilterByType DEFLATE text/xml
	AddOutputFilterByType DEFLATE text/css
	AddOutputFilterByType DEFLATE application/xml
	AddOutputFilterByType DEFLATE application/xhtml+xml
	AddOutputFilterByType DEFLATE application/rss+xml
	AddOutputFilterByType DEFLATE application/javascript
	AddOutputFilterByType DEFLATE application/x-javascript
	AddOutputFilterByType DEFLATE application/json
	AddOutputFilterByType DEFLATE image/svg+xml
</IfModule>

# Caching (long cache for hashed build assets)
<IfModule mod_expires.c>
	ExpiresActive On
	# Static assets
	ExpiresByType text/css "access plus 1 year"
	ExpiresByType text/javascript "access plus 1 year"
	ExpiresByType application/javascript "access plus 1 year"
	ExpiresByType application/wasm "access plus 1 year"
	ExpiresByType image/svg+xml "access plus 1 year"
	ExpiresByType image/jpeg "access plus 1 year"
	ExpiresByType image/png "access plus 1 year"
	ExpiresByType image/webp "access plus 1 year"
	ExpiresByType application/json "access plus 1 day"
	# Default
	ExpiresDefault "access plus 1 hour"
</IfModule>

# SPA routing without breaking real asset requests
<IfModule mod_rewrite.c>
	RewriteEngine On

	# Canonical redirects
	# Force HTTPS
	RewriteCond %{HTTPS} !=on
	RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

	# Redirect www to non-www
	RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
	RewriteRule ^ https://%1%{REQUEST_URI} [L,R=301]

	# Remove index.html from URLs
	RewriteRule ^index\.html$ / [L,R=301]

	# Never rewrite existing files or directories
	RewriteCond %{REQUEST_FILENAME} -f [OR]
	RewriteCond %{REQUEST_FILENAME} -d
	RewriteRule ^ - [L]

	# Do not rewrite known static asset paths
	RewriteRule ^(assets/|uploads/|favicon\.ico$|manifest\.json$|robots\.txt$|sitemap\.xml$|sw\.js$) - [L]

	# Only rewrite to index.html for navigations (HTML requests)
	RewriteCond %{REQUEST_FILENAME} !-f
	RewriteCond %{REQUEST_FILENAME} !-d
	RewriteCond %{HTTP:Accept} text/html [OR]
	RewriteCond %{REQUEST_URI} ^/?$
	RewriteRule . /index.html [L]
</IfModule>

# Cache control for sitemap
<Files "sitemap.xml">
	ExpiresActive On
	ExpiresDefault "access plus 1 day"
</Files>
